<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>🤖 Humanoid Scientist Brain — Phase F Dashboard</title>
<link rel="stylesheet" href="/static/style.css" />
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif; margin: 28px; color: #111; }
  h1 { font-size: 28px; margin-bottom: 6px; }
  h2 { margin-top: 30px; }
  .metric { font-size: 16px; margin: 4px 0; }
  .section { margin: 26px 0 40px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
  .card { border: 1px solid #e6e6e6; border-radius: 12px; padding: 14px 16px; background: #fff; }
  .muted { color: #666; }
  canvas { max-width: 100%; }
  img.graph { border: 1px solid #ddd; border-radius: 10px; margin-top: 10px; width: 100%; max-width: 1000px; }
  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; margin-left: 6px; }
</style>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadState() {
  const res = await fetch("/state");
  return await res.json();
}
async function loadHistory() {
  const res = await fetch("/history");
  return await res.json();
}
async function loadValidated() {
  const res = await fetch("/validated");
  return await res.json();
}

function asFixed(x, n=4) {
  if (x === null || x === undefined) return "–";
  const f = Number(x);
  return Number.isFinite(f) ? f.toFixed(n) : "–";
}

let trainChart = null;

async function render() {
  try {
    const [state, hist, val] = await Promise.all([loadState(), loadHistory(), loadValidated()]);

    // Header stats
    document.getElementById("cycle").textContent = state.cycle ?? "–";
    document.getElementById("device").textContent = state.device ?? hist.device ?? "–";
    document.getElementById("nodes").textContent = state.kg?.nodes ?? 0;
    document.getElementById("edges").textContent = state.kg?.edges ?? 0;
    document.getElementById("loss").textContent = asFixed(state.training?.online_loss);
    document.getElementById("sim").textContent = asFixed(state.training?.online_sim);
    document.getElementById("vocab").textContent = state.training?.vocab_size ?? (hist.vocab?.slice(-1)[0] ?? "–");

    // Recent papers
    const papers = document.getElementById("papers");
    papers.innerHTML = "";
    (state.recent_papers || []).forEach(p => {
      const li = document.createElement("li");
      li.textContent = p;
      papers.appendChild(li);
    });

    // KG Visualization
    const vis = document.getElementById("graphImg");
    if (state.latest_graph) {
      vis.src = state.latest_graph + "?cb=" + Date.now();
      vis.style.display = "block";
    } else if (state.visualization) {
      vis.src = "/" + state.visualization + "?cb=" + Date.now();
      vis.style.display = "block";
    } else {
      vis.style.display = "none";
    }

    // Training chart
    const ctx = document.getElementById("trainChart").getContext("2d");
    if (trainChart) trainChart.destroy();
    trainChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: hist.epochs || [],
        datasets: [
          { label: "Loss", data: hist.loss || [], fill: false },
          { label: "Similarity", data: hist.similarity || [], fill: false },
          { label: "Accuracy", data: hist.accuracy || [], fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { position: "top" } },
        scales: {
          x: { title: { display: true, text: "Epoch" } },
          y: { title: { display: true, text: "Value" }, suggestedMin: 0.0, suggestedMax: 1.0 }
        }
      }
    });

    // Hypothesis snapshot
    document.getElementById("hypTotal").textContent = val.total ?? 0;
    document.getElementById("hypPromoted").textContent = val.promoted ?? 0;
    document.getElementById("hypAvg").textContent = asFixed(val.avg_confidence, 3);

    const hypList = document.getElementById("hypList");
    hypList.innerHTML = "";
    (val.items || []).forEach(row => {
      const div = document.createElement("div");
      div.className = "card";
      const p = document.createElement("div");
      p.textContent = row.hypothesis;
      const meta = document.createElement("div");
      meta.className = "muted";
      meta.innerHTML = `persistence=${asFixed(row.persistence,3)} <span class="pill">obs ${row.observations}</span>`;
      div.appendChild(p);
      div.appendChild(meta);
      hypList.appendChild(div);
    });
  } catch (err) {
    console.error("Dashboard error:", err);
  }
}

window.onload = () => {
  render();
  // refresh every 20s
  setInterval(render, 20000);
};
</script>
</head>
<body>
  <h1>🤖 Humanoid Scientist Brain — Phase F Dashboard</h1>
  <div class="muted">Live: training metrics, knowledge graph, and hypothesis snapshot</div>

  <div class="section grid">
    <div class="card">
      <h2>Run</h2>
      <div class="metric">Cycle: <b id="cycle">–</b></div>
      <div class="metric">Device: <b id="device">–</b></div>
      <div class="metric">Vocab size: <b id="vocab">–</b></div>
    </div>
    <div class="card">
      <h2>Knowledge Graph</h2>
      <div class="metric"><b id="nodes">0</b> nodes / <b id="edges">0</b> edges</div>
    </div>
    <div class="card">
      <h2>Training (latest)</h2>
      <div class="metric">Loss: <b id="loss">–</b></div>
      <div class="metric">Similarity: <b id="sim">–</b></div>
    </div>
  </div>

  <div class="section">
    <h2>🧪 Training History</h2>
    <div class="card" style="height: 360px;">
      <canvas id="trainChart"></canvas>
    </div>
  </div>

  <div class="section">
    <h2>📰 Recent Papers</h2>
    <ul id="papers"><li class="muted">Loading…</li></ul>
  </div>

  <div class="section">
    <h2>🕸️ Knowledge Graph Visualization</h2>
    <img id="graphImg" class="graph" src="" alt="Graph visualization" style="display:none;">
  </div>

  <div class="section">
    <h2>✅ Hypothesis Snapshot</h2>
    <div class="grid">
      <div class="card"><div class="metric">Total tracked: <b id="hypTotal">0</b></div></div>
      <div class="card"><div class="metric">Promoted (persistence≥0.7): <b id="hypPromoted">0</b></div></div>
      <div class="card"><div class="metric">Avg persistence: <b id="hypAvg">0.000</b></div></div>
    </div>
    <div id="hypList" class="grid" style="margin-top:12px;"></div>
  </div>
</body>
</html>
